generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
  VIEWER
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
}

enum OrderStatus {
  DRAFT
  PENDING
  APPROVED
  RECEIVED
  CANCELLED
}

enum SalesStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum NotificationType {
  LOW_STOCK
  EXPIRY_ALERT
  ORDER_UPDATE
  SYSTEM
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  fullName  String   @map("full_name")
  phone     String?
  isActive  Boolean  @default(true) @map("is_active")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  role                Role               @relation(fields: [roleId], references: [id])
  refreshTokens       RefreshToken[]
  userPermissions     UserPermission[]
  companies           Company[]
  stockMovements      StockMovement[]
  purchaseOrders      PurchaseOrder[]
  salesOrders         SalesOrder[]
  notifications       Notification[]
  activityLogs        ActivityLog[]
  managedLocations    Location[]

  @@index([email])
  @@index([roleId])
  @@map("users")
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  displayName String   @map("display_name")
  description String?  @db.Text
  level       Int      @default(0)
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users           User[]
  rolePermissions RolePermission[]

  @@index([name])
  @@index([level])
  @@map("roles")
}

model Permission {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  displayName String   @map("display_name")
  description String?  @db.Text
  resource    String
  action      String
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@index([name])
  @@index([resource])
  @@index([action])
  @@map("permissions")
}

model RolePermission {
  id           Int      @id @default(autoincrement())
  roleId       Int      @map("role_id")
  permissionId Int      @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserPermission {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  permissionId Int      @map("permission_id")
  type         String   @default("grant")
  createdAt    DateTime @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@map("user_permissions")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @db.Text
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Company {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  industry    String?
  address     String?  @db.Text
  city        String?
  country     String?
  phone       String?
  email       String?
  website     String?
  logoUrl     String?  @map("logo_url")
  taxId       String?  @map("tax_id")
  isActive    Boolean  @default(true) @map("is_active")
  ownerId     Int      @map("owner_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  owner      User        @relation(fields: [ownerId], references: [id])
  locations  Location[]
  suppliers  Supplier[]

  @@index([ownerId])
  @@index([name])
  @@map("companies")
}

model Location {
  id        Int      @id @default(autoincrement())
  name      String
  type      String   @default("warehouse")
  address   String?  @db.Text
  city      String?
  country   String?
  companyId Int      @map("company_id")
  managerId Int?     @map("manager_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager        User?           @relation(fields: [managerId], references: [id])
  stock          Stock[]
  stockMovements StockMovement[]

  @@index([companyId])
  @@index([managerId])
  @@index([type])
  @@map("locations")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  parentId    Int?     @map("parent_id")
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([parentId])
  @@map("categories")
}

model Product {
  id              Int      @id @default(autoincrement())
  name            String
  sku             String   @unique
  barcode         String?  @unique
  categoryId      Int?     @map("category_id")
  description     String?  @db.Text
  unitOfMeasure   String   @default("pcs") @map("unit_of_measure")
  costPrice       Decimal  @default(0) @map("cost_price") @db.Decimal(10, 2)
  sellingPrice    Decimal  @default(0) @map("selling_price") @db.Decimal(10, 2)
  reorderLevel    Int      @default(10) @map("reorder_level")
  imageUrl        String?  @map("image_url")
  isActive        Boolean  @default(true) @map("is_active")
  trackInventory  Boolean  @default(true) @map("track_inventory")
  hasExpiry       Boolean  @default(false) @map("has_expiry")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  category            Category?             @relation(fields: [categoryId], references: [id])
  stock               Stock[]
  stockMovements      StockMovement[]
  purchaseOrderItems  PurchaseOrderItem[]
  salesOrderItems     SalesOrderItem[]

  @@index([sku])
  @@index([barcode])
  @@index([categoryId])
  @@map("products")
}

model Stock {
  id          Int       @id @default(autoincrement())
  productId   Int       @map("product_id")
  locationId  Int       @map("location_id")
  quantity    Int       @default(0)
  batchNumber String?   @map("batch_number")
  expiryDate  DateTime? @map("expiry_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId, batchNumber])
  @@index([productId])
  @@index([locationId])
  @@index([expiryDate])
  @@map("stock")
}

model StockMovement {
  id            Int          @id @default(autoincrement())
  productId     Int          @map("product_id")
  locationId    Int          @map("location_id")
  quantity      Int
  movementType  MovementType @map("movement_type")
  referenceType String?      @map("reference_type")
  referenceId   Int?         @map("reference_id")
  batchNumber   String?      @map("batch_number")
  userId        Int          @map("user_id")
  notes         String?      @db.Text
  createdAt     DateTime     @default(now()) @map("created_at")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([locationId])
  @@index([movementType])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("stock_movements")
}

model Supplier {
  id             Int      @id @default(autoincrement())
  name           String
  contactPerson  String?  @map("contact_person")
  email          String?
  phone          String?
  address        String?  @db.Text
  city           String?
  country        String?
  taxId          String?  @map("tax_id")
  paymentTerms   String?  @map("payment_terms")
  rating         Decimal  @default(0) @map("rating") @db.Decimal(3, 2)
  companyId      Int      @map("company_id")
  isActive       Boolean  @default(true) @map("is_active")
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@index([name])
  @@index([companyId])
  @@map("suppliers")
}

model PurchaseOrder {
  id             Int          @id @default(autoincrement())
  poNumber       String       @unique @map("po_number")
  supplierId     Int          @map("supplier_id")
  orderDate      DateTime     @map("order_date")
  expectedDate   DateTime?    @map("expected_date")
  status         OrderStatus  @default(DRAFT)
  totalAmount    Decimal      @default(0) @map("total_amount") @db.Decimal(12, 2)
  taxAmount      Decimal      @default(0) @map("tax_amount") @db.Decimal(10, 2)
  shippingCost   Decimal      @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  discountAmount Decimal      @default(0) @map("discount_amount") @db.Decimal(10, 2)
  notes          String?      @db.Text
  createdById    Int          @map("created_by_id")
  approvedById   Int?         @map("approved_by_id")
  approvedAt     DateTime?    @map("approved_at")
  receivedAt     DateTime?    @map("received_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  supplier  Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  createdBy User                @relation(fields: [createdById], references: [id])
  items     PurchaseOrderItem[]

  @@index([poNumber])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               Int      @id @default(autoincrement())
  purchaseOrderId  Int      @map("purchase_order_id")
  productId        Int      @map("product_id")
  quantity         Int
  receivedQuantity Int      @default(0) @map("received_quantity")
  unitPrice        Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice       Decimal  @map("total_price") @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model SalesOrder {
  id              Int           @id @default(autoincrement())
  soNumber        String        @unique @map("so_number")
  customerName    String        @map("customer_name")
  customerEmail   String?       @map("customer_email")
  customerPhone   String?       @map("customer_phone")
  customerAddress String?       @db.Text @map("customer_address")
  orderDate       DateTime      @map("order_date")
  status          SalesStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID) @map("payment_status")
  paymentMethod   String?       @map("payment_method")
  totalAmount     Decimal       @default(0) @map("total_amount") @db.Decimal(12, 2)
  taxAmount       Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  shippingCost    Decimal       @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  discountAmount  Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  paidAmount      Decimal       @default(0) @map("paid_amount") @db.Decimal(12, 2)
  notes           String?       @db.Text
  createdById     Int           @map("created_by_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  createdBy User             @relation(fields: [createdById], references: [id])
  items     SalesOrderItem[]

  @@index([soNumber])
  @@index([customerName])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderDate])
  @@map("sales_orders")
}

model SalesOrderItem {
  id           Int      @id @default(autoincrement())
  salesOrderId Int      @map("sales_order_id")
  productId    Int      @map("product_id")
  quantity     Int
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice   Decimal  @map("total_price") @db.Decimal(12, 2)
  createdAt    DateTime @default(now()) @map("created_at")

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@index([salesOrderId])
  @@index([productId])
  @@map("sales_order_items")
}

model Notification {
  id            Int              @id @default(autoincrement())
  userId        Int              @map("user_id")
  type          NotificationType
  title         String
  message       String           @db.Text
  isRead        Boolean          @default(false) @map("is_read")
  referenceType String?          @map("reference_type")
  referenceId   Int?             @map("reference_id")
  createdAt     DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   Int?     @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @db.Text @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}